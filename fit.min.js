function fit(str,pre){function tokenizer(e){var r="{{",t="}}",n=e.split(r);return n.reduce(function(e,r){if(r.indexOf(t)>-1){var n=r.split(t);return e.push("{{OP_"+n[0].trimLeft()),e.push(n[1]),e}return e.push(r),e},[])}function parser(e){var r=[],t=[];if(e.forEach(function(e){if(0===e.indexOf("{{OP_")){var n=e.substr(5),s=n.trim().split(/ |\$/)[0];if(oplist.indexOf(s)>-1)switch(s){case"=":t.length>0?t[t.length-1]["else"]?t[t.length-1]["else"].push(exp["="](n)):t[t.length-1].param.push(exp["="](n)):r.push(exp["="](n));break;case"for":t.push({exp:n,param:[]});break;case"endfor":var p=t.pop();t.length>0?t[t.length-1].param.push(exp["for"](p.exp,p.param)):r.push(exp["for"](p.exp,p.param));break;case"if":t.push({exp:n,param:[]});break;case"else":t[t.length-1]["else"]=[];break;case"endif":var p=t.pop();t.length>0?t[t.length-1]["else"]?t[t.length-1]["else"].push(exp["if"](p.exp,p.param,p["else"])):t[t.length-1].param.push(exp["if"](p.exp,p.param,p["else"])):r.push(exp["if"](p.exp,p.param,p["else"]))}else t.length>0?t[t.length-1]["else"]?!!t[t.length-1]["else"].push("{{unknown("+s+")}}"):t[t.length-1].param.push("{{unknown("+s+")}}"):r.push("{{unknown("+s+")}}")}else t.length>0?t[t.length-1]["else"]?t[t.length-1]["else"].push(e):t[t.length-1].param.push(e):r.push(e)}),t.length>0)throw"`for` or `if` statement not terminated.";return r}function render(e,r){return e.reduce(function(e,t){return"function"==typeof t?e+t(r):e+t},"")}String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")});var oplist=["=","for","endfor","if","else","endif"],exp={"=":function(e){return function(r){var t=e.substr(1).trim().substr(1).split(".");return t.reduce(function(e,r){return e[r]},r)}},"for":function(e,r){var t=e.substr(3).trim().split("as"),n=t[0].trim().substr(1).split("."),s=t[1].trim().substr(1);return function(e){var t=n.reduce(function(e,r){return e[r]},e),p="";return t&&t.forEach(function(e,t){var n={};n[s]=e,n[s].index=t,p+=r.reduce(function(e,r){return"function"==typeof r?e+r(n):e+r},"")}),p}},"if":function(_exp,_param,_else){var e=_exp.substr(2).trim();return function(data){e=e.replace(/\$/g,"data.");var s=eval(e)?_param:_else;return s.reduce(function(e,r){return"function"==typeof r?e+r(data):e+r},"")}}},parsed;return pre&&(parsed=parser(tokenizer(str))),function(e){return void 0===parsed&&(parsed=parser(tokenizer(str))),render(parsed,e)}}module&&(module.exports=fit);